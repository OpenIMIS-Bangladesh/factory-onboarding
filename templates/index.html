<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ফ্যাক্টরী নিবন্ধন </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fontawesome-free/css/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/select2.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="{{ url_for('static', filename='jquery/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/select2.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/datepicker.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
</head>

<body>
    {% if error %}
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="liveToast" class="toast show text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-triangle me-2"></i> <strong>ত্রুটি:</strong> {{ message }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
    <script>
        // Auto-remove the error notification after a delay (if not using Toastr for all messages)
        $(document).ready(function() {
            setTimeout(function() {
                $('#liveToast').toast('hide');
            }, 5000);
        });
    </script>
    {% endif %}
    <div class="container my-4">
        <div class="row">
            <div class="col-md-12">
                <div class="p-3 sticky-instructions">
                    <p class="mb-2 fs-6 fw-bold"><i class="fas fa-info-circle me-2"></i> গুরুত্বপূর্ণ নির্দেশনা</p>
                    <ul class="text-left small">
                        <li>ফ্যাক্টরীর সঠিক তথ্য এবং প্রতিনিধির জাতীয় পরিচয়পত্র অনুযায়ী তথ্য দিয়ে **নিবন্ধনের আবেদন** সম্পন্ন করুন।</li>
                        <li>সফলভাবে নিবন্ধনের আবেদন সংশ্লিষ্ট **এসোসিয়েশন কর্তৃক অনুমোদিত** হবে।</li>
                        <li>অনুমোদন সাপেক্ষে আপনার প্রদত্ত ইমেইলে আইডি এবং পাসওয়ার্ড পাঠানো হবে।</li>
                        <li>ইমেইলে পাওয়া আইডি এবং পাসওয়ার্ড ব্যবহার করে আপনি ফ্যাক্টরীর প্রতিনিধি হিসেবে লগ ইন করতে পারবেন <a href="" id="page_link" class="text-reset text-decoration-underline fw-bold">এই লিংকে</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid bg-white py-3 shadow-sm sticky-top" style="z-index: 1020;">
        <div class="row">
            <div class="col-md-12 d-flex flex-column justify-content-center">
                <div class="step-progress">
                    <div class="step active" id="step-1">
                        <div class="step-icon">১</div>
                        <div class="step-text">ফ্যাক্টরীর তথ্য দিন</div>
                    </div>
                    <div class="step" id="step-2">
                        <div class="step-icon">২</div>
                        <div class="step-text">প্রতিনিধির তথ্য দিন</div>
                    </div>
                    <div class="step" id="step-3">
                        <div class="step-icon">৩</div>
                        <div class="step-text">জমা দিন</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="d-flex align-items-center">
                    <button class="icon-circle btn p-0" onclick="window.location.href.includes('eis')?window.location.href='{{eis_page}}':window.location.href='{{cf_page}}'">
                        <i class="fas fa-arrow-left"></i> </button>
                    <h2 class="d-inline mb-0 text-dark">ফ্যাক্টরী নিবন্ধন আবেদন ✍️</h2>
                </div>
                <hr class="mt-2">
            </div>
        </div>



        <form action="{{url_alias}}/submit_form" id="factoryForm" method="POST" enctype="multipart/form-data">
            <div class="row" id="form-section-1">
                <div class="col-md-12">
                    <div class="card mb-4">
                        <div class="card-header py-3 bg-white d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-building me-2"></i> ফ্যাক্টরীর মৌলিক তথ্য</span>
                            <span class="badge badge-factory text-bg-primary">ধাপ ১/২</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="custom-input w-100">
                                        <input type="text" id="factory_name_en" name="factory_name_en" value="{{ form_data.get('factory_name_en') if form_data else "" }}" placeholder="প্রতিষ্ঠান/ কারখানার নাম (ইংরেজি)" required>
                                        <label for="factory_name_en" class="required">প্রতিষ্ঠান/ কারখানার নাম (ইংরেজি)</label>
                                    </div>
                                    <div class="custom-select w-100">
                                        <label for="association" class="required">প্রতিষ্ঠান/ কারখানার অ্যাসোসিয়েশন</label>
                                        <select id="association" name="association" class="w-100 select2" required>
                                            <option class="select-items" value="" disabled selected hidden></option>
                                            <option class="select-items" value="BGMEA" {{ "selected" if form_data and form_data.get('association')=="BGMEA" else "" }}>BGMEA</option>
                                            <option class="select-items" value="BKMEA" {{ "selected" if form_data and form_data.get('association')=="BKMEA" else "" }}>BKMEA</option>
                                            <option class="select-items" value="BEPZA" {{ "selected" if form_data and form_data.get('association')=="BEPZA" else "" }}>BEPZA</option>
                                        </select>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="group_name" name="group_name" value="{{ form_data.get('group_name') if form_data else "" }}" placeholder="গ্রুপের নাম (যদি থাকে)">
                                        <label for="group_name">গ্রুপের নাম (যদি থাকে)</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="license_type" name="license_type" value="{{ form_data.get('license_type') if form_data else "" }}" placeholder="লাইসেন্সের ধরণ" required>
                                        <label for="license_type" class="required">লাইসেন্সের ধরণ</label>
                                    </div>
                                    <div class="custom-select w-100">
                                        <label for="is_lima_registered" class="required">LIMA-তে নিবন্ধন রয়েছে?</label>
                                        <select id="is_lima_registered" name="is_lima_registered" class="w-100 select2" onchange="changeLimaFields()" required>
                                            <option class="select-items" value="no" {{ "selected" if form_data and form_data.get('association')=="no" else "" }}>না</option>
                                            <option class="select-items" value="yes" {{ "selected" if form_data and form_data.get('association')=="yes" else "" }}>হ্যাঁ</option>
                                        </select>
                                    </div>
                                    <div class="custom-input w-100" id="lima_registration_number_div" style="display: none;">
                                        <input type="text" id="lima_registration_number" name="lima_registration_number" value="{{ form_data.get('lima_registration_number') if form_data else "" }}" placeholder="LIMA নিবন্ধন নম্বর">
                                        <label for="lima_registration_number" class="required">LIMA নিবন্ধন নম্বর</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="factory_phone" name="factory_phone" value="{{ form_data.get('factory_phone') if form_data else "" }}" placeholder="ফোন নম্বর">
                                        <label for="factory_phone">ফোন নম্বর</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="factory_web" name="factory_web" value="{{ form_data.get('factory_web') if form_data else "" }}" placeholder="ওয়েবসাইট">
                                        <label for="factory_web">ওয়েবসাইট</label>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="custom-input w-100">
                                        <input type="text" id="factory_name_bn" name="factory_name_bn" value="{{ form_data.get('factory_name_bn') if form_data else "" }}" placeholder="প্রতিষ্ঠান/ কারখানার নাম (বাংলা)" required>
                                        <label for="factory_name_bn" class="required">প্রতিষ্ঠান/ কারখানার নাম (বাংলা)</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="membership_no" name="membership_no" value="{{ form_data.get('membership_no') if form_data else "" }}" placeholder="এসোসিয়েশন কর্তৃক প্রদত্ত মেম্বারশিপ নম্বর" required>
                                        <label for="factory_email" class="required">এসোসিয়েশন কর্তৃক প্রদত্ত মেম্বারশিপ নম্বর</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="business_sector" name="business_sector" value="{{ form_data.get('business_sector') if form_data else "" }}" placeholder="ব্যাবসার ধরণ" required>
                                        <label for="business_sector" class="required">ব্যাবসার ধরণ</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="license_no" name="license_no" value="{{ form_data.get('license_no') if form_data else "" }}" placeholder="লাইসেন্স নম্বর" required>
                                        <label for="license_no" class="required">লাইসেন্স নম্বর</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="" name="date_of_factory_establishment" class="datepicker" value="{{ form_data.get('date_of_factory_establishment') if form_data else "" }}" placeholder="প্রতিষ্ঠানের প্রতিষ্ঠার তারিখ" required>
                                        <label for="date_of_factory_establishment" class="required">প্রতিষ্ঠানের প্রতিষ্ঠার তারিখ</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="" name="approximate_number_of_employee" value="{{ form_data.get('approximate_number_of_employee') if form_data else "" }}" placeholder="প্রতিষ্ঠানের কর্মচারীর সংখ্যা" required>
                                        <label for="approximate_number_of_employee" class="required">প্রতিষ্ঠানের কর্মচারীর সংখ্যা</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="factory_email" name="factory_email" value="{{ form_data.get('factory_email') if form_data else "" }}" placeholder="ই-মেইল">
                                        <label for="factory_email">ই-মেইল</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <label for="file_upload" class="form-label fw-bold required">কারখানার মেম্বারশিপ সার্টিফিকেট আপলোড করুন <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="মেম্বারশিপ সার্টিফিকেটটি PDF বা JPEG ফরম্যাটে আপলোড করুন।"></i>
                                    </label>
                                    <input type="file" style="display: none;" name="file_upload" id="file-upload" required accept=".pdf, .jpg, .jpeg, .png">
                                    <div class="card mt-2 d-flex flex-row justify-content-center align-items-center file-upload-box" onclick="document.getElementById('file-upload').click();">
                                        <i class="fa fa-cloud-upload-alt me-2 fs-5"></i>
                                        <span>ফাইল আপলোড করতে ক্লিক করুন</span>
                                    </div>
                                    <div id="file-preview" class="mt-2">
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-4">
                        <div class="card-header py-3 bg-white">
                            <span><i class="fas fa-map-marker-alt me-2"></i> ফ্যাক্টরীর ঠিকানা</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12">
                                    <div class="custom-input w-100">
                                        <input type="text" id="factory_address" name="factory_address" value="{{ form_data.get('factory_address') if form_data else "" }}" placeholder="গ্রাম/ প্লট/ বাড়ি/ রাস্তা" required>
                                        <label for="factory_address" class="required">গ্রাম/ প্লট/ বাড়ি/ রাস্তা</label>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-4 custom-select">
                                        <label for="factory_division" class="form-label  required">বিভাগ</label>
                                        <select name="factory_division" id="factory_division"
                                            onchange="loadLocation(this, 'factory_district')"
                                            class="w-100 select2" required>
                                            <option value="">নির্বাচন করুন</option>
                                            {% for location in locations %}
                                            <option value="{{ location.LocationId }}" {{ "selected" if form_data and form_data.get('factory_division') else "" }}>{{
                                                location.LocationName }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-4 custom-select">
                                        <label for="factory_district" class="form-label  required">জেলা/সিটি কর্পোরেশন</label>
                                        <select name="factory_district" id="factory_district"
                                            onchange="loadLocation(this, 'factory_thana')"
                                            class="w-100 select2" required>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-4 custom-select">
                                        <label for="factory_thana" class="form-label  required">উপজেলা/থানা/পৌরসভা</label>
                                        <select name="factory_thana" id="factory_thana"
                                            onchange="loadLocation(this, 'factory_ward')"
                                            class="w-100 select2" required>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-4 custom-select">
                                        <label for="factory_ward" class="form-label  required">ইউনিয়ন/ওয়ার্ড</label>
                                        <select name="factory_ward" id="factory_ward"
                                            onchange="loadLocation(this, '')" class="w-100 select2"
                                            required>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-4">
                        <div class="card-header py-3 bg-white">
                            <span><i class="fas fa-map-marker-alt me-2"></i> অফিসের ঠিকানা</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12">
                                    <div class="custom-input w-100">
                                        <input type="text" id="office_address" name="office_address" value="{{ form_data.get('office_address') if form_data else "" }}" placeholder="গ্রাম/ প্লট/ বাড়ি/ রাস্তা" required>
                                        <label for="office_address" class="required">গ্রাম/ প্লট/ বাড়ি/ রাস্তা</label>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-4 custom-select">
                                        <label for="office_division" class="form-label  required">বিভাগ</label>
                                        <select name="office_division" id="office_division"
                                            onchange="loadLocation(this, 'office_district')"
                                            class="w-100 select2" required>
                                            <option value="">নির্বাচন করুন</option>
                                            {% for location in locations %}
                                            <option value="{{ location.LocationId }}" {{ "selected" if form_data and form_data.get('office_division') else "" }}>{{
                                                location.LocationName }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-4 custom-select">
                                        <label for="office_district" class="form-label  required">জেলা/সিটি কর্পোরেশন</label>
                                        <select name="office_district" id="office_district"
                                            onchange="loadLocation(this, 'office_thana')"
                                            class="w-100 select2" required>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-4 custom-select">
                                        <label for="office_thana" class="form-label  required">উপজেলা/থানা/পৌরসভা</label>
                                        <select name="office_thana" id="office_thana"
                                            onchange="loadLocation(this, 'office_ward')"
                                            class="w-100 select2" required>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-4 custom-select">
                                        <label for="office_ward" class="form-label  required">ইউনিয়ন/ওয়ার্ড</label>
                                        <select name="office_ward" id="office_ward"
                                            onchange="loadLocation(this, '')" class="w-100 select2"
                                            required>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" id="form-section-2">
                <div class="col-md-12">
                    <div class="card mb-4">
                        <div class="card-header py-3 bg-white d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-user-tie me-2"></i> ফ্যাক্টরী প্রতিনিধির তথ্য</span>
                            <span class="badge badge-representative text-bg-secondary">ধাপ ২/২</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="custom-input w-100">
                                        <input type="text" id="representative_name" name="representative_name" value="{{ form_data.get('representative_name') if form_data else '' }}" placeholder="প্রতিনিধির নাম (ইংরেজি)" required>
                                        <label for="representative_name" class="required">প্রতিনিধির নাম (ইংরেজি)</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="representative_designation"
                                            name="representative_designation" value="{{ form_data.get('representative_designation') if form_data else '' }}" placeholder="পদবী" required>
                                        <label for="representative_designation" class="required">পদবী</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="representative_email" name="representative_email" value="{{ form_data.get('representative_email') if form_data else '' }}" placeholder="ই-মেইল">
                                        <label for="representative_email">ই-মেইল</label>
                                    </div>
                                    <!-- <div class="custom-input w-100">
                                        <input type="text" id="representative_passport" name="representative_passport" value="{{ form_data.get('representative_passport') if form_data else '' }}">
                                        <label for="representative_passport">পাসপোর্ট নম্বর</label>
                                    </div> -->
                                    <div class="custom-input w-100">
                                        <input type="text" class="datepicker" id="representative_dob" value="{{ form_data.get('representative_dob') if form_data else '' }}" name="representative_dob" placeholder="জন্মতারিখ">
                                        <label for="representative_dob">জন্মতারিখ</label>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="custom-input w-100">
                                        <input type="text" id="representative_name_bn" name="representative_name_bn" value="{{ form_data.get('representative_name_bn') if form_data else '' }}" placeholder="প্রতিনিধির নাম (বাংলা)"
                                            required>
                                        <label for="representative_name_bn" class="required">প্রতিনিধির নাম (বাংলা)</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="representative_phone" name="representative_phone" value="{{ form_data.get('representative_phone') if form_data else '' }}" placeholder="ফোন নম্বর (লগইন ইউজারনেম হিসেবে ব্যবহৃত হবে)" required>
                                        <label for="representative_phone" class="required">ফোন নম্বর (লগইন ইউজারনেম হিসেবে ব্যবহৃত হবে)</label>
                                    </div>
                                    <div class="custom-input w-100">
                                        <input type="text" id="representative_nid" name="representative_nid" value="{{ form_data.get('representative_nid') if form_data else '' }}" placeholder="জাতীয় পরিচয়পত্র নম্বর" required>
                                        <label for="representative_nid" class="required">জাতীয় পরিচয়পত্র নম্বর</label>
                                    </div>
                                    
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card border shadow-none">
                                        <div class="card-header bg-light">
                                            <span class="small fw-bold"><i class="fas fa-home me-2"></i> প্রতিনিধির ঠিকানা</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="custom-input w-100">
                                                        <input type="text" id="representative_address"
                                                            name="representative_address" value="{{ form_data.get('representative_address') if form_data else '' }}" placeholder="গ্রাম/ প্লট/ বাড়ি/ রাস্তা" required>
                                                        <label for="representative_address" class="required">গ্রাম/ প্লট/ বাড়ি/ রাস্তা</label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-4 custom-select">
                                                        <label for="representative_division" class="form-label  required">বিভাগ</label>
                                                        <select name="representative_division"
                                                            id="representative_division"
                                                            onchange="loadLocation(this, 'representative_district')"
                                                            class="w-100 select2" required>
                                                            <option value="">নির্বাচন করুন</option>
                                                            {% for location in locations %}
                                                            <option value="{{ location.LocationId }}" {{ "selected" if form_data and form_data.get('representative_division') else "" }}>{{
                                                                location.LocationName }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-4 custom-select">
                                                        <label for="representative_district" class="form-label  required">জেলা/সিটি কর্পোরেশন</label>
                                                        <select name="representative_district"
                                                            id="representative_district"
                                                            onchange="loadLocation(this, 'representative_thana')"
                                                            class="w-100 select2" required>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-4 custom-select">
                                                        <label for="representative_thana" class="form-label  required">উপজেলা/থানা/পৌরসভা</label>
                                                        <select name="representative_thana" id="representative_thana"
                                                            onchange="loadLocation(this, 'representative_ward')"
                                                            class="w-100 select2" required>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-4 custom-select">
                                                        <label for="representative_ward" class="form-label  required">ইউনিয়ন/ওয়ার্ড</label>
                                                        <select name="representative_ward" id="representative_ward"
                                                            onchange="loadLocation(this, '')" class="w-100 select2"
                                                            required>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid mt-4 mb-5">
                <div class="row">
                    <div class="col-md-12 text-center">
                        <button type="submit" class="btn btn-lg px-5 py-3 text-light"
                            style="background-color: var(--primary-color); border:none; border-radius: 50px; font-weight: bold;"><i class="fa fa-paper-plane me-2"></i>
                            নিবন্ধন আবেদন জমা দিন</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="errorToast" class="toast text-bg-danger border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">

                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>


    <script>
        $(document).ready(function () {
            // Initialize Select2 and Tooltips
            $('.select2').select2({
                allowClear: true,
                placeholder: "নির্বাচন করুন" // Added placeholder for Select2
            });

            // Initialize all tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })

            $('.datepicker').datepicker({
                format: 'dd-mm-yyyy',
                autoclose: true,
                todayHighlight: true,
                language: 'bn'
            });

            if(window.location.href.includes('eis')){
                $('#page_link').attr('href', '{{eis_page}}');
            } else {
                $('#page_link').attr('href', '{{cf_page}}');
            }

            // Toastr Setup (Original functionality kept)
            toastr.options = {
                "closeButton": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "timeOut": "3000"
            };

            // Phone Number Validation (Original functionality kept)
            $("#factory_phone, #representative_phone").on("change", function () {
                this.value = this.value.replace(/[^0-9]/g, '');
                let phone = $(this).val();

                if (phone.length > 0 && phone.length < 11) {
                    toastr.error("ফোন নম্বর অবশ্যই ১১-সংখ্যার হতে হবে।");
                } else if (phone.length >= 11) {
                    const bdPhoneRegex = /^01[3-9]\d{8}$/;
                    if (!bdPhoneRegex.test(phone)) {
                       // Use toastr for non-blocking error display
                       toastr.error("ভুল বাংলাদেশি ফোন নম্বর! উদাহরণ: 017xxxxxxxx");
                    }
                }
            });

            // UX Feature: Form Step Visual Update on Scroll/Focus (Optional)
            // For simplicity and not adding new complex dependencies, I'm using a static step visual.
            // If the user scrolls down to representative info, we can mark step 2 active.
            $(window).scroll(function() {
                var repSectionTop = $('#form-section-2').offset().top;
                var scrollTop = $(window).scrollTop();
                if (scrollTop > repSectionTop - 300) { // Adjust 300px buffer
                    $('#step-1').removeClass('active').addClass('completed');
                    $('.badge-factory').removeClass('text-bg-secondary').addClass('text-bg-primary');
                    $('#step-2').addClass('active');
                } else {
                    $('#step-1').addClass('active').removeClass('completed');
                    $('.badge-representative').removeClass('text-bg-secondary').addClass('text-bg-primary');
                    $('#step-2').removeClass('active');
                }
            });
        });

        // File Upload Preview (Improved Look)
        document.getElementById('file-upload').addEventListener('change', function () {
            const file = this.files[0];
            const previewContainer = document.getElementById('file-preview');
            previewContainer.innerHTML = ''; // Clear old preview

            if (file) {
                const fileDiv = document.createElement('div');
                fileDiv.classList.add('d-flex', 'align-items-center', 'justify-content-between', 'p-3', 'border', 'rounded', 'bg-white', 'shadow-sm');

                const fileInfo = document.createElement('div');
                fileInfo.innerHTML = `<i class="fa fa-file-alt me-2 text-primary"></i> <span style="font-weight: bold; color: var(--primary-color); word-break: break-all;">${file.name}</span> <span class="text-muted small">(${(file.size / 1024).toFixed(2)} KB)</span>`;

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fa fa-times"></i>';
                deleteBtn.classList.add('btn', 'btn-sm', 'btn-outline-danger');
                deleteBtn.style.marginLeft = '15px';
                deleteBtn.onclick = function () {
                    document.getElementById('file-upload').value = '';
                    previewContainer.innerHTML = '';
                };

                fileDiv.appendChild(fileInfo);
                fileDiv.appendChild(deleteBtn);
                previewContainer.appendChild(fileDiv);
            }
        });

        function changeLimaFields() {
            console.log('LIMA field change triggered');
            value = $('#is_lima_registered option:selected').val();
            if (value == 'yes') {
                $('#lima_registration_number_div').fadeIn("slow");
            } else {
                $('#lima_registration_number_div').fadeOut("slow");
                $('#lima_registration_number').val("");
            }
        }

        // Location Load Function (Original functionality kept)
        function loadLocation(object, domId) {
            const parentId = object.value;
            // Clear subsequent fields
            const fieldMap = {
                'factory_division': ['factory_district', 'factory_thana', 'factory_ward'],
                'factory_district': ['factory_thana', 'factory_ward'],
                'factory_thana': ['factory_ward'],
                'representative_division': ['representative_district', 'representative_thana', 'representative_ward'],
                'representative_district': ['representative_thana', 'representative_ward'],
                'representative_thana': ['representative_ward']
            };

            (fieldMap[object.id] || []).forEach(id => {
                $("#" + id).val('').trigger('change');
                // Ensure only one default option is present
                $("#" + id).html('<option value="">নির্বাচন করুন</option>').select2('destroy').select2({allowClear: true, placeholder: "নির্বাচন করুন"});
            });

            if (!domId) return; // Stop if no next field

            fetch(`${window.location.href}/api/get_locations?parent_id=${parentId}`)
                .then(response => response.json())
                .then(data => {
                    const locationsSelect = document.getElementById(domId);
                    locationsSelect.innerHTML = '';

                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.text = 'নির্বাচন করুন';
                    locationsSelect.appendChild(defaultOption);

                    data.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc.id;
                        option.text = loc.name;
                        locationsSelect.appendChild(option);
                    });
                    // Reinitialize select2 to recognize new options
                    $('#' + domId).select2({allowClear: true, placeholder: "নির্বাচন করুন"});

                })
                .catch(error => {
                    //toastr.error('ঠিকানার তথ্য লোড করতে ব্যর্থ: ' + error);
                    console.error('Error fetching locations:', error);
                });
        }
    </script>
</body>

</html>